<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.renren.modules.inspection.dao.InspectionTaskDeviceDao">

	<!-- 可根据自己的需求，是否要使用 -->
    <resultMap type="io.renren.modules.inspection.entity.InspectionTaskDeviceEntity" id="inspectionTaskDeviceMap">
        <result property="id" column="id"/>
        <result property="lineId" column="line_id"/>
        <result property="turnId" column="turn_id"/>
        <result property="deviceId" column="device_id"/>
        <result property="inspectionDate" column="inspection_date"/>
        <result property="insepctItemCount" column="insepct_item_count"/>
        <result property="inspectedItemCount" column="inspected_item_count"/>
        <result property="isUpdate" column="is_update"/>
    </resultMap>

    <select id="selectMissingStatisticsByDate" resultType="java.util.HashMap" parameterType="java.lang.String">
        select device.device_name as deviceName,count(device.device_id) as count
        from tb_inspection_task_device as task
        left join tb_device as device on device.device_id=task.device_id
        left join tb_inspection_line as line on line.id=task.`line_id`
        left join tb_turn as turn on turn.id=task.turn_id
        left join sys_dept as dept on dept.dept_id=line.dept_id
        left join tb_inspection_period as period on period.line_id=line.id
        where task.is_inspected=1 and task.inspected_item_count &lt; task.insepct_item_count and task.inspection_date >= '${inspectStartDate}' and task.inspection_date &lt; '${inspectEndDate}'
        <if test="deptIds!=null">
            and dept.dept_id in
            <foreach item="item" index="index" collection="deptIds" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="lineId!=null">
            and line.id=#{lineId}
        </if>
        group by device.device_id
    </select>

    <select id="selectMissingDetailByDate" resultType="java.util.HashMap" parameterType="java.lang.String">
        select device.device_name as deviceName,line.name as lineName,turn.id as turnId,turn.name as turnName,
        task.inspection_date as inspectionDate,task.start_time as startTime,task.end_time as endTime,task.create_time as createTime
        from tb_inspection_task_device as task
        left join tb_device as device on device.device_id=task.device_id
        left join tb_inspection_line as line on line.id=task.`line_id`
        left join tb_turn as turn on turn.id=task.turn_id
        left join sys_dept as dept on dept.dept_id=line.dept_id
        left join tb_inspection_period as period on period.line_id=line.id
        where task.is_inspected=1 and task.inspected_item_count &lt; task.insepct_item_count and task.inspection_date >= '${inspectStartDate}' and task.inspection_date &lt; '${inspectEndDate}'
        <if test="deptIds!=null">
            and dept.dept_id in
            <foreach item="item" index="index" collection="deptIds" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="lineId!=null">
            and line.id=#{lineId}
        </if>
        order by task.inspection_date desc ,line.id,device.device_id,turn.id asc
    </select>

    <select id="selectMissingLineByDate" resultType="java.util.HashMap" parameterType="java.lang.String">
        select dept.name as deptName,line.name as lineName,task.inspection_date as inspectionDate,
        count(task.line_id) as inspectCount,sum(case task.is_inspected when 1 then 1 else 0 end) as inspectedCount,
        count(task.line_id) - sum(case task.is_inspected when 1 then 1 else 0 end) as inspectMissCount,
        concat(round((count(task.line_id) - sum(case task.is_inspected when 1 then 1 else 0 end))/count(task.line_id)*100,2),'%') as inspectMissRate,
        '${inspectStartDate}' as inspectStartDate,'${inspectEndDate}' as inspectEndDate
        from tb_inspection_task_device as task
        left join tb_inspection_line as line on line.id=task.`line_id`
        left join tb_turn as turn on turn.id=task.turn_id
        left join sys_dept as dept on dept.dept_id=line.dept_id
        left join tb_inspection_period as period on period.line_id=line.id
        where task.inspected_item_count &lt; task.insepct_item_count and task.inspection_date >= '${inspectStartDate}' and task.inspection_date &lt; '${inspectEndDate}'
        <if test="deptIds!=null">
            and dept.dept_id in
            <foreach item="item" index="index" collection="deptIds" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="lineId!=null">
            and line.id=#{lineId}
        </if>
        group by line.id
    </select>

    <select id="selectMissingTurnByDate" resultType="java.util.HashMap" parameterType="java.lang.String">
        select dept.name as deptName,line.name as lineName,task.inspection_date as inspectionDate,turn.id as turnId,turn.name as turnName,
        count(task.line_id) as inspectCount,sum(case task.is_inspected when 1 then 1 else 0 end) as inspectedCount,
        count(task.line_id) - sum(case task.is_inspected when 1 then 1 else 0 end) as inspectMissCount,
        concat(round((count(task.line_id) - sum(case task.is_inspected when 1 then 1 else 0 end))/count(task.line_id)*100,2),'%') as inspectMissRate,
        '${inspectStartDate}' as inspection_start_date,'${inspectEndDate}' as inspection_end_date
        from tb_inspection_task_device as task
        left join tb_inspection_line as line on line.id=task.`line_id`
        left join tb_turn as turn on turn.id=task.turn_id
        left join sys_dept as dept on dept.dept_id=line.dept_id
        left join tb_inspection_period as period on period.line_id=line.id
        where task.inspected_item_count &lt; task.insepct_item_count and task.inspection_date >= '${inspectStartDate}' and task.inspection_date &lt; '${inspectEndDate}'
        <if test="deptIds!=null">
            and dept.dept_id in
            <foreach item="item" index="index" collection="deptIds" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="lineId!=null">
            and line.id=#{lineId}
        </if>
        group by line.id,turn.id
    </select>
</mapper>